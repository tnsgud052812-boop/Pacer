<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ï∫îÌÉëÏä§ ÎßåÎ≥¥Í±∑Í∏∞ Î¶¨Ìè¨Ìä∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Noto Sans KR', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: #1e293b;
            color: #fff;
            padding: 24px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 0.85rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        .header-right {
            text-align: right;
        }

        .header-date {
            font-size: 0.9rem;
            color: #94a3b8;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .header-btn {
            padding: 6px 14px;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            color: #fff;
            text-decoration: none;
            font-size: 0.8rem;
            border: none;
            cursor: pointer;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* ÏöîÏïΩ Ïπ¥Îìú */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid #3b82f6;
        }

        .summary-card.gold { border-left-color: #f59e0b; }
        .summary-card.green { border-left-color: #10b981; }
        .summary-card.purple { border-left-color: #8b5cf6; }

        .summary-label {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1e293b;
        }

        .summary-sub {
            font-size: 0.8rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* ÏÑπÏÖò */
        .section {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .section-header {
            background: #f8fafc;
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .section-body {
            padding: 24px;
        }

        /* ÌÉ≠ */
        .tabs {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 8px;
            width: fit-content;
        }

        .tab {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .tab.active {
            background: #fff;
            color: #1e293b;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* ÌÖåÏù¥Î∏î */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 16px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
            background: #f8fafc;
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.9rem;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        .data-table tbody tr {
            cursor: pointer;
        }

        /* ÏàúÏúÑ Î±ÉÏßÄ */
        .rank-cell {
            width: 60px;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .rank-1 { background: #fef3c7; color: #d97706; }
        .rank-2 { background: #f1f5f9; color: #64748b; }
        .rank-3 { background: #fed7aa; color: #c2410c; }
        .rank-default { background: #f8fafc; color: #94a3b8; }

        /* Í±∏ÏùåÏàò Î∞î */
        .steps-cell {
            width: 200px;
        }

        .steps-bar-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .steps-bar-bg {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .steps-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .steps-value {
            font-weight: 600;
            color: #1e293b;
            min-width: 80px;
            text-align: right;
        }

        /* ÌåÄ Ïπ¥Îìú */
        .team-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .team-header {
            padding: 16px 20px;
            background: #f8fafc;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .team-header:hover {
            background: #f1f5f9;
        }

        .team-rank {
            font-size: 1.2rem;
            font-weight: 700;
            min-width: 40px;
        }

        .team-rank.gold { color: #d97706; }
        .team-rank.silver { color: #64748b; }
        .team-rank.bronze { color: #c2410c; }
        .team-rank.default { color: #94a3b8; }

        .team-info {
            flex: 1;
        }

        .team-name {
            font-weight: 600;
            color: #1e293b;
            font-size: 1rem;
        }

        .team-meta {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 2px;
        }

        .team-stats {
            text-align: right;
        }

        .team-avg {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
        }

        .team-avg-label {
            font-size: 0.75rem;
            color: #64748b;
        }

        .team-expand {
            color: #94a3b8;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .team-card.expanded .team-expand {
            transform: rotate(180deg);
        }

        .team-body {
            display: none;
            border-top: 1px solid #e2e8f0;
            padding: 16px 20px;
        }

        .team-card.expanded .team-body {
            display: block;
        }

        .member-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f8fafc;
            cursor: pointer;
        }

        .member-row:hover {
            background: #f8fafc;
            margin: 0 -12px;
            padding-left: 12px;
            padding-right: 12px;
        }

        .member-row:last-child {
            border-bottom: none;
        }

        .member-rank-num {
            width: 28px;
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 600;
        }

        .member-name {
            flex: 1;
            font-size: 0.9rem;
        }

        .member-avg {
            font-weight: 600;
            color: #1e293b;
            margin-right: 8px;
        }

        .member-total {
            font-size: 0.8rem;
            color: #94a3b8;
        }

        /* Ï∞®Ìä∏ */
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .chart-box {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .chart-full {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
        }

        /* Î™®Îã¨ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #fff;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: #f1f5f9;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            font-size: 1.2rem;
            color: #64748b;
            cursor: pointer;
        }

        .modal-close:hover {
            background: #e2e8f0;
        }

        .modal-body {
            padding: 24px;
        }

        /* ÌÜµÍ≥Ñ Í∑∏Î¶¨Îìú */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-box {
            background: #f8fafc;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }

        .stat-box-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-box-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }

        .stat-box-sub {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 2px;
        }

        /* Ï∫òÎ¶∞Îçî */
        .calendar {
            margin-top: 24px;
        }

        .calendar-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 12px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-header {
            text-align: center;
            font-size: 0.7rem;
            color: #94a3b8;
            padding: 8px 0;
            font-weight: 600;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.8rem;
            background: #f8fafc;
        }

        .calendar-day.empty {
            background: transparent;
        }

        .calendar-day.has-data {
            background: #dbeafe;
        }

        .calendar-day.today {
            border: 2px solid #3b82f6;
        }

        .calendar-day .day-num {
            font-weight: 600;
            color: #475569;
        }

        .calendar-day .day-steps {
            font-size: 0.6rem;
            color: #64748b;
        }

        /* Î°úÎî© */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .spinner {
            width: 36px;
            height: 36px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Í≤ÄÏÉâ */
        .search-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 0.9rem;
            background: #f8fafc;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: #fff;
        }

        /* Î∞òÏùëÌòï */
        @media (max-width: 900px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .header {
                padding: 16px 20px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }
            .header-right {
                text-align: center;
            }
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
            .container {
                padding: 16px;
            }
            .section-body {
                padding: 16px;
            }
            .steps-cell {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <div class="header-title">Ï∫îÌÉëÏä§ ÎßåÎ≥¥Í±∑Í∏∞ Î¶¨Ìè¨Ìä∏</div>
            <div class="header-subtitle">ÌåÄÎ≥Ñ ÏùºÏùº ÌèâÍ∑† Í±∏ÏùåÏàò ÌòÑÌô©</div>
        </div>
        <div class="header-right">
            <div class="header-date" id="updateTime">Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...</div>
            <div class="header-buttons">
                <button onclick="location.reload(true)" class="header-btn">üîÑ ÏÉàÎ°úÍ≥†Ïπ®</button>
                <a href="admin.html" class="header-btn">‚öôÔ∏è Í¥ÄÎ¶¨Ïûê</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- ÏöîÏïΩ Ïπ¥Îìú -->
        <div class="summary-grid">
            <div class="summary-card">
                <div class="summary-label">Ï∞∏Ïó¨ Ïù∏Ïõê</div>
                <div class="summary-value" id="totalMembers">-</div>
                <div class="summary-sub">Î™Ö</div>
            </div>
            <div class="summary-card gold">
                <div class="summary-label">Ï†ÑÏ≤¥ ÏùºÌèâÍ∑†</div>
                <div class="summary-value" id="totalAvg">-</div>
                <div class="summary-sub">Î≥¥/Ïùº</div>
            </div>
            <div class="summary-card green">
                <div class="summary-label">1ÏúÑ ÌåÄ</div>
                <div class="summary-value" id="topTeam">-</div>
                <div class="summary-sub" id="topTeamAvg"></div>
            </div>
            <div class="summary-card purple">
                <div class="summary-label">Ïù¥Î≤àÎã¨ Í≤ΩÍ≥º</div>
                <div class="summary-value" id="dayOfMonth">-</div>
                <div class="summary-sub">Ïùº</div>
            </div>
        </div>

        <!-- ÏùºÎ≥Ñ Ï∂îÏù¥ Í∑∏ÎûòÌîÑ -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üìà Î©§Î≤ÑÎ≥Ñ ÏõîÎàÑÏ†Å Ï∂îÏù¥</div>
            </div>
            <div class="section-body">
                <div id="dailyChartContainer">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Î©îÏù∏ ÏÑπÏÖò -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üèÜ ÏàúÏúÑ ÌòÑÌô©</div>
                <div class="tabs">
                    <button class="tab active" data-tab="teams" onclick="switchTab('teams')">ÌåÄ ÏàúÏúÑ</button>
                    <button class="tab" data-tab="all" onclick="switchTab('all')">Ï†ÑÏ≤¥ Îû≠ÌÇπ</button>
                </div>
            </div>
            <div class="section-body">
                <!-- ÌåÄ ÏàúÏúÑ -->
                <div id="teamsTab">
                    <div id="teamRankings">
                        <div class="loading">
                            <div class="spinner"></div>
                            <div>Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Îäî Ï§ë...</div>
                        </div>
                    </div>
                </div>

                <!-- Ï†ÑÏ≤¥ Îû≠ÌÇπ -->
                <div id="allTab" style="display:none;">
                    <div style="margin-bottom:16px;">
                        <input type="text" class="search-input" id="searchInput" 
                               placeholder="üîç Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ..." oninput="filterAllRanking()">
                    </div>
                    <div style="max-height:500px;overflow-y:auto;border:1px solid #e2e8f0;border-radius:8px;">
                        <table class="data-table">
                            <thead style="position:sticky;top:0;z-index:1;">
                                <tr>
                                    <th class="rank-cell">ÏàúÏúÑ</th>
                                    <th>Ïù¥Î¶Ñ</th>
                                    <th>ÏÜåÏÜç</th>
                                    <th class="steps-cell">ÏùºÌèâÍ∑†</th>
                                    <th style="text-align:right;">Î≥¥/Ïùº</th>
                                </tr>
                            </thead>
                            <tbody id="allRankingBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÌÜµÍ≥Ñ Ï∞®Ìä∏ -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">üìä ÌÜµÍ≥Ñ</div>
            </div>
            <div class="section-body">
                <div class="chart-grid">
                    <div class="chart-box">
                        <div class="chart-title">ÌåÄÎ≥Ñ ÏùºÌèâÍ∑† ÎπÑÍµê</div>
                        <canvas id="teamChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <div class="chart-title">Í±∏ÏùåÏàò Î∂ÑÌè¨</div>
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Í∞úÏù∏ ÏÉÅÏÑ∏ Î™®Îã¨ -->
    <div class="modal-overlay" id="memberModal" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Í∞úÏù∏ Í∏∞Î°ù</span>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Î°úÎî© Ï§ë...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const REPO_OWNER = 'tnsgud052812-boop';
        const REPO_NAME = 'Pacer';
        const BRANCH = 'main';

        let config = { teams: [] };
        let latestData = [];
        let dailyHistory = [];
        let teamChartInstance = null;
        let distChartInstance = null;
        let dailyChartInstance = null;

        document.addEventListener('DOMContentLoaded', loadAllData);

        async function loadAllData() {
            // ÏàúÏÑú Ï§ëÏöî: config Î®ºÏ†Ä, Í∑∏ Îã§Ïùå latest, ÎßàÏßÄÎßâÏóê dailyHistory
            await loadConfig();
            await loadLatestData();
            await loadDailyHistory();
            
            renderSummary();
            renderTeamRankings();
            renderAllRanking();
            renderCharts();
            renderDailyChart();
        }

        async function loadConfig() {
            try {
                const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/config.json?t=${Date.now()}`;
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    // Í∑∏Î£π Íµ¨Ï°∞ÏóêÏÑú ÌåÄÎßå Ï∂îÏ∂ú (ÌïòÏúÑ Ìò∏Ìôò)
                    if (data.groups) {
                        config.teams = [];
                        data.groups.forEach(g => {
                            (g.teams || []).forEach(t => {
                                config.teams.push(t);
                            });
                        });
                        config.admins = data.admins;
                    } else if (data.teams) {
                        config = data;
                    }
                }
            } catch (e) {
                console.error('ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', e);
            }
        }

        async function loadLatestData() {
            try {
                const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/latest.csv?t=${Date.now()}`;
                const res = await fetch(url);
                const csv = await res.text();
                latestData = parseCSV(csv);
                
                if (latestData.length > 0 && latestData[0]['ÌÅ¨Î°§ÎßÅÏùºÏãú']) {
                    document.getElementById('updateTime').textContent = 
                        `ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏: ${latestData[0]['ÌÅ¨Î°§ÎßÅÏùºÏãú']}`;
                }
            } catch (e) {
                console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
            }
        }

        async function loadDailyHistory() {
            try {
                const now = new Date();
                const monthFolder = `${now.getFullYear()}ÎÖÑ${now.getMonth() + 1}Ïõî`;
                const registered = getRegisteredMembers();
                
                // Î©§Î≤ÑÎ≥Ñ ÏùºÎ≥Ñ ÎàÑÏ†Å Îç∞Ïù¥ÌÑ∞
                const memberHistory = {};
                registered.forEach(name => {
                    memberHistory[name] = [];
                });
                
                const dates = [];
                
                for (let i = 1; i <= now.getDate(); i++) {
                    const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const dateLabel = `${now.getMonth() + 1}/${i}`;
                    
                    try {
                        const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/daily/${monthFolder}/${dateStr}.csv`;
                        const res = await fetch(url);
                        
                        if (res.ok) {
                            const csv = await res.text();
                            const data = parseCSV(csv);
                            
                            dates.push(dateLabel);
                            
                            // Í∞Å Î©§Î≤ÑÏùò ÏõîÎàÑÏ†Å Í∏∞Î°ù
                            registered.forEach(name => {
                                const row = data.find(d => d['Ïù¥Î¶Ñ'] === name);
                                const monthly = row ? (parseInt(row['ÏõîÍ∞ÑÎàÑÏ†Å']) || parseInt(row['ÏõîÎàÑÏ†Å']) || 0) : null;
                                memberHistory[name].push(monthly);
                            });
                        }
                    } catch (e) {}
                }
                
                dailyHistory = { dates, memberHistory };
            } catch (e) {
                console.error('ÏùºÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', e);
                dailyHistory = { dates: [], memberHistory: {} };
            }
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            const headers = lines[0].split(',');
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim()] = values[idx]?.trim() || '';
                });
                data.push(row);
            }
            return data;
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.getElementById('teamsTab').style.display = tab === 'teams' ? 'block' : 'none';
            document.getElementById('allTab').style.display = tab === 'all' ? 'block' : 'none';
        }

        function getMemberData(name) {
            return latestData.find(d => d['Ïù¥Î¶Ñ'] === name) || {};
        }

        function getRegisteredMembers() {
            const members = new Set();
            (config.teams || []).forEach(t => {
                (t.members || []).forEach(m => members.add(m));
            });
            return members;
        }

        function getRegisteredMemberData() {
            const registered = getRegisteredMembers();
            return latestData.filter(d => registered.has(d['Ïù¥Î¶Ñ']));
        }

        function getTeamStats() {
            const today = new Date();
            const dayOfMonth = today.getDate();

            return (config.teams || []).map(team => {
                let totalSteps = 0;
                let memberCount = 0;

                (team.members || []).forEach(name => {
                    const data = getMemberData(name);
                    totalSteps += parseInt(data['ÏõîÎàÑÏ†Å']) || 0;
                    memberCount++;
                });

                const avgDaily = memberCount > 0 ? Math.floor(totalSteps / memberCount / dayOfMonth) : 0;

                return {
                    ...team,
                    totalSteps,
                    avgDaily,
                    memberCount
                };
            }).sort((a, b) => b.avgDaily - a.avgDaily);
        }

        function renderSummary() {
            const today = new Date();
            const dayOfMonth = today.getDate();
            
            document.getElementById('dayOfMonth').textContent = dayOfMonth;
            
            const registeredData = getRegisteredMemberData();
            document.getElementById('totalMembers').textContent = registeredData.length;

            let totalSteps = 0;
            registeredData.forEach(d => {
                totalSteps += parseInt(d['ÏõîÎàÑÏ†Å']) || 0;
            });
            const totalAvg = registeredData.length > 0 ? Math.floor(totalSteps / registeredData.length / dayOfMonth) : 0;
            document.getElementById('totalAvg').textContent = formatNumber(totalAvg);

            const teamStats = getTeamStats();
            if (teamStats.length > 0) {
                document.getElementById('topTeam').textContent = teamStats[0].name;
                document.getElementById('topTeamAvg').textContent = formatNumber(teamStats[0].avgDaily) + ' Î≥¥/Ïùº';
            }
        }

        function renderTeamRankings() {
            const container = document.getElementById('teamRankings');
            const teamStats = getTeamStats();
            
            if (teamStats.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#94a3b8;">
                        ÏïÑÏßÅ ÌåÄÏù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.<br>
                        <a href="admin.html" style="color:#3b82f6;">Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ</a>ÏóêÏÑú ÌåÄÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
                    </div>
                `;
                return;
            }

            const today = new Date();
            const dayOfMonth = today.getDate();

            container.innerHTML = teamStats.map((team, idx) => {
                const rank = idx + 1;
                let rankClass = 'default';
                if (rank === 1) rankClass = 'gold';
                else if (rank === 2) rankClass = 'silver';
                else if (rank === 3) rankClass = 'bronze';

                const memberStats = (team.members || []).map(name => {
                    const data = getMemberData(name);
                    const monthlyTotal = parseInt(data['ÏõîÎàÑÏ†Å']) || 0;
                    const dailyAvg = Math.floor(monthlyTotal / dayOfMonth);
                    return { name, dailyAvg, total: monthlyTotal };
                }).sort((a, b) => b.dailyAvg - a.dailyAvg);

                return `
                    <div class="team-card" id="team-${team.id}">
                        <div class="team-header" onclick="toggleTeam('${team.id}')">
                            <div class="team-rank ${rankClass}">#${rank}</div>
                            <div class="team-info">
                                <div class="team-name">${team.name}</div>
                                <div class="team-meta">${team.memberCount}Î™Ö</div>
                            </div>
                            <div class="team-stats">
                                <div class="team-avg">${formatNumber(team.avgDaily)}</div>
                                <div class="team-avg-label">Î≥¥/Ïùº</div>
                            </div>
                            <div class="team-expand">‚ñº</div>
                        </div>
                        <div class="team-body">
                            ${memberStats.map((m, mIdx) => `
                                <div class="member-row" onclick="showMemberDetail('${m.name}')">
                                    <span class="member-rank-num">${mIdx + 1}</span>
                                    <span class="member-name">${m.name}</span>
                                    <span class="member-avg">${formatNumber(m.dailyAvg)}</span>
                                    <span class="member-total">(${formatNumber(m.total)})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleTeam(teamId) {
            const el = document.getElementById(`team-${teamId}`);
            el.classList.toggle('expanded');
        }

        function renderAllRanking(filter = '') {
            const tbody = document.getElementById('allRankingBody');
            const today = new Date();
            const dayOfMonth = today.getDate();
            
            const registeredData = getRegisteredMemberData();
            
            const memberTeamMap = {};
            (config.teams || []).forEach(t => {
                (t.members || []).forEach(m => {
                    memberTeamMap[m] = t.name;
                });
            });

            let sortedData = registeredData.map(d => {
                const monthlyTotal = parseInt(d['ÏõîÎàÑÏ†Å']) || 0;
                const dailyAvg = Math.floor(monthlyTotal / dayOfMonth);
                return { ...d, dailyAvg };
            }).sort((a, b) => b.dailyAvg - a.dailyAvg);

            const maxAvg = sortedData.length > 0 ? sortedData[0].dailyAvg : 1;

            const filtered = filter 
                ? sortedData.filter(d => d['Ïù¥Î¶Ñ'].toLowerCase().includes(filter.toLowerCase()))
                : sortedData;

            tbody.innerHTML = filtered.map((row, idx) => {
                const rank = idx + 1;
                let rankClass = 'rank-default';
                if (rank === 1) rankClass = 'rank-1';
                else if (rank === 2) rankClass = 'rank-2';
                else if (rank === 3) rankClass = 'rank-3';

                const team = memberTeamMap[row['Ïù¥Î¶Ñ']] || '-';
                const barWidth = (row.dailyAvg / maxAvg * 100).toFixed(1);

                return `
                    <tr onclick="showMemberDetail('${row['Ïù¥Î¶Ñ']}')">
                        <td class="rank-cell"><span class="rank-badge ${rankClass}">${rank}</span></td>
                        <td><strong>${row['Ïù¥Î¶Ñ']}</strong></td>
                        <td style="color:#64748b;font-size:0.8rem;">${team}</td>
                        <td class="steps-cell">
                            <div class="steps-bar-container">
                                <div class="steps-bar-bg">
                                    <div class="steps-bar" style="width:${barWidth}%"></div>
                                </div>
                            </div>
                        </td>
                        <td style="text-align:right;">
                            <span class="steps-value">${formatNumber(row.dailyAvg)}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterAllRanking() {
            const query = document.getElementById('searchInput').value;
            renderAllRanking(query);
        }

        function renderDailyChart() {
            if (!dailyHistory.dates || dailyHistory.dates.length === 0) {
                document.getElementById('dailyChartContainer').innerHTML = 
                    '<div style="text-align:center;color:#94a3b8;padding:40px;">ÏùºÎ≥Ñ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
                return;
            }

            const ctx = document.getElementById('dailyChart');
            if (dailyChartInstance) dailyChartInstance.destroy();

            // ÏÉâÏÉÅ ÌåîÎ†àÌä∏
            const colors = [
                '#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6',
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#e11d48', '#0ea5e9', '#22c55e', '#a855f7',
                '#f43f5e', '#0891b2', '#65a30d', '#ea580c', '#7c3aed'
            ];

            // Îç∞Ïù¥ÌÑ∞ÏÖã ÏÉùÏÑ±
            const datasets = [];
            let colorIdx = 0;
            
            for (const [name, data] of Object.entries(dailyHistory.memberHistory)) {
                // nullÏù¥ ÏïÑÎãå Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÎäî Î©§Î≤ÑÎßå
                if (data.some(v => v !== null)) {
                    datasets.push({
                        label: name,
                        data: data,
                        borderColor: colors[colorIdx % colors.length],
                        backgroundColor: 'transparent',
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        borderWidth: 2
                    });
                    colorIdx++;
                }
            }

            dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyHistory.dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.dataset.label}: ${formatNumber(ctx.raw)} Í±∏Ïùå`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: (v) => formatNumber(v)
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderCharts() {
            const teamStats = getTeamStats();
            
            if (teamStats.length === 0) {
                document.getElementById('teamChart').parentElement.innerHTML = 
                    '<div style="text-align:center;color:#94a3b8;padding:40px;">ÌåÄ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
                document.getElementById('distributionChart').parentElement.innerHTML = 
                    '<div style="text-align:center;color:#94a3b8;padding:40px;">Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div>';
                return;
            }

            // ÌåÄ ÎπÑÍµê Ï∞®Ìä∏
            const teamCtx = document.getElementById('teamChart');
            if (teamChartInstance) teamChartInstance.destroy();
            
            teamChartInstance = new Chart(teamCtx, {
                type: 'bar',
                data: {
                    labels: teamStats.map(t => t.name),
                    datasets: [{
                        label: 'ÏùºÌèâÍ∑† (Î≥¥/Ïùº)',
                        data: teamStats.map(t => t.avgDaily),
                        backgroundColor: teamStats.map((t, i) => {
                            if (i === 0) return '#f59e0b';
                            if (i === 1) return '#94a3b8';
                            if (i === 2) return '#c2410c';
                            return '#3b82f6';
                        }),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Î∂ÑÌè¨ Ï∞®Ìä∏
            const today = new Date();
            const dayOfMonth = today.getDate();
            
            const registeredData = getRegisteredMemberData();
            const avgData = registeredData.map(d => {
                const total = parseInt(d['ÏõîÎàÑÏ†Å']) || 0;
                return Math.floor(total / dayOfMonth);
            });

            const ranges = [
                { label: '5Ï≤ú ÎØ∏Îßå', min: 0, max: 5000 },
                { label: '5Ï≤ú~1Îßå', min: 5000, max: 10000 },
                { label: '1Îßå~1.5Îßå', min: 10000, max: 15000 },
                { label: '1.5Îßå~2Îßå', min: 15000, max: 20000 },
                { label: '2Îßå Ïù¥ÏÉÅ', min: 20000, max: Infinity }
            ];

            const distData = ranges.map(r => 
                avgData.filter(v => v >= r.min && v < r.max).length
            );

            const distCtx = document.getElementById('distributionChart');
            if (distChartInstance) distChartInstance.destroy();

            distChartInstance = new Chart(distCtx, {
                type: 'doughnut',
                data: {
                    labels: ranges.map(r => r.label),
                    datasets: [{
                        data: distData,
                        backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { boxWidth: 12, padding: 12 }
                        }
                    }
                }
            });
        }

        async function showMemberDetail(name) {
            const modal = document.getElementById('memberModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = name;
            modalBody.innerHTML = '<div class="loading"><div class="spinner"></div>Î°úÎî© Ï§ë...</div>';
            modal.classList.add('active');

            const today = new Date();
            const dayOfMonth = today.getDate();
            const currentData = getMemberData(name);
            const monthlyTotal = parseInt(currentData['ÏõîÎàÑÏ†Å']) || 0;
            const dailyAvg = Math.floor(monthlyTotal / dayOfMonth);
            
            const monthStr = `${today.getFullYear()}ÎÖÑ${today.getMonth() + 1}Ïõî`;
            const fileName = encodeURIComponent(`${name}_${monthStr}_Data.csv`);
            const url = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/data/members/${fileName}?t=${Date.now()}`;

            let history = [];
            try {
                const res = await fetch(url);
                if (res.ok) {
                    const csv = await res.text();
                    history = parseCSV(csv);
                }
            } catch (e) {}

            const dailySteps = history.map(h => parseInt(h['Ïò§ÎäòÍ±∏ÏùåÏàò']) || 0).filter(v => v > 0);
            const totalDays = dailySteps.length;
            const avgSteps = totalDays > 0 ? Math.floor(dailySteps.reduce((a,b) => a+b, 0) / totalDays) : 0;
            const maxSteps = dailySteps.length > 0 ? Math.max(...dailySteps) : 0;
            const minSteps = dailySteps.length > 0 ? Math.min(...dailySteps) : 0;
            const maxDay = history.find(h => parseInt(h['Ïò§ÎäòÍ±∏ÏùåÏàò']) === maxSteps)?.['ÎÇ†Ïßú'] || '-';
            const minDay = history.find(h => parseInt(h['Ïò§ÎäòÍ±∏ÏùåÏàò']) === minSteps)?.['ÎÇ†Ïßú'] || '-';

            modalBody.innerHTML = `
                <div class="stat-grid">
                    <div class="stat-box">
                        <div class="stat-box-value">${formatNumber(dailyAvg)}</div>
                        <div class="stat-box-label">ÏùºÌèâÍ∑† (Î≥¥/Ïùº)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${formatNumber(monthlyTotal)}</div>
                        <div class="stat-box-label">Ïõî ÎàÑÏ†Å</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${formatNumber(maxSteps)}</div>
                        <div class="stat-box-label">ÏµúÎåÄ</div>
                        <div class="stat-box-sub">${maxDay}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${formatNumber(minSteps)}</div>
                        <div class="stat-box-label">ÏµúÏÜå</div>
                        <div class="stat-box-sub">${minDay}</div>
                    </div>
                </div>

                <div style="height:200px;">
                    <canvas id="memberChart"></canvas>
                </div>

                <div class="calendar">
                    <div class="calendar-title">üìÖ ${today.getFullYear()}ÎÖÑ ${today.getMonth() + 1}Ïõî</div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            `;

            renderMemberChart(history);
            renderCalendar(today.getFullYear(), today.getMonth(), history);
        }

        function renderMemberChart(history) {
            const ctx = document.getElementById('memberChart');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => h['ÎÇ†Ïßú']),
                    datasets: [{
                        label: 'ÏùºÎ≥Ñ Í±∏ÏùåÏàò',
                        data: history.map(h => parseInt(h['Ïò§ÎäòÍ±∏ÏùåÏàò']) || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderCalendar(year, month, history) {
            const grid = document.getElementById('calendarGrid');
            const today = new Date();
            
            const historyMap = {};
            history.forEach(h => {
                historyMap[h['ÎÇ†Ïßú']] = parseInt(h['Ïò§ÎäòÍ±∏ÏùåÏàò']) || 0;
            });

            const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
            let html = days.map(d => `<div class="calendar-header">${d}</div>`).join('');

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day empty"></div>';
            }

            for (let date = 1; date <= lastDate; date++) {
                const dateStr = `${String(month + 1).padStart(2, '0')}/${String(date).padStart(2, '0')}`;
                const steps = historyMap[dateStr];
                const isToday = year === today.getFullYear() && month === today.getMonth() && date === today.getDate();
                const hasData = steps !== undefined;

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${hasData ? 'has-data' : ''}">
                        <div class="day-num">${date}</div>
                        ${hasData ? `<div class="day-steps">${(steps/1000).toFixed(0)}k</div>` : ''}
                    </div>
                `;
            }

            grid.innerHTML = html;
        }

        function closeModal() {
            document.getElementById('memberModal').classList.remove('active');
        }

        function formatNumber(n) {
            return n.toLocaleString('ko-KR');
        }
    </script>
</body>
</html>
